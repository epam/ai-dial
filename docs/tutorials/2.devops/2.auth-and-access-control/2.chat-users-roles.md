# Roles and Access Control for JWT

## Introduction

You can configure DIAL to work with various identity service providers, where you can manage your users and user groups. In the [DIAL Core Dynamic Settings](https://github.com/epam/ai-dial-core?tab=readme-ov-file#dynamic-settings), you can enable roles and configure their access to system resources. 

> Refer to [About Roles](/docs/platform/3.core/2.access-control-intro.md#about-roles) to learn more. 

## Step 1: Configure IDP

For DIAL Chat users, you can define user groups/roles/pools (it depends on a specific IDP) in your identity service provider (IDP) which are then passed to DIAL Core in JWT. 

> Refer to [Configure IDPs](/docs/tutorials/2.devops/2.auth-and-access-control/3.configure-idps/0.overview.md) to view supported IDPs and learn how to configure them.

## Step 2: Configure DIAL Core

### Add Roles

You can then utilize user roles from the JWT claims to define roles in the DIAL Core dynamic settings as a `userRoles` parameter value. In the following example, we grant access to `chat-gpt-35-turbo` model for users with the `operator` user role. Using the same pattern, you can define user access to applications.

```json
"models": {
    "chat-gpt-35-turbo": {
        "userRoles": [
            "operator"
            ]
        }
}
```

> Refer to [DIAL Core Dynamic Settings](https://github.com/epam/ai-dial-core?tab=readme-ov-file#dynamic-settings) to view the description of all the supported configuration parameters.

**IMPORTANT**: 

* Always use roles from the JWT claims that you receive from your IDP. 
* If a user's IDP roles aren't explicitly mentioned in the DIAL configuration, a "default" role is applied. 
* If the "default" role is not defined or has no limits set, access to the resource is **unrestricted**. 

### Add Limits

In the `roles` section of the DIAL Core dynamic settings, you can include token usage, cost and also sharing limits for roles. 

> * Refer to [Token Limits and Cost Control](/docs/platform/3.core/8.token-limits-and-cost-control.md) to learn more about these mechanisms.
> * Refer to [DIAL Core](https://github.com/epam/ai-dial-core/blob/development/docs/dynamic-settings/roles.md) to learn how to configure roles.

**Effective role rule**: 

* If a user has a role A and B from the IDP which are not mentioned in the `roles` section, limits from the `default` role apply. 
* If the `default` role is not defined in the `roles` section or does not have limits configured for it - the **access is unlimited**.

#### Token Limit

Token rate limiting controls the volume of tokens processed by AI models within specific timeframes. The system tracks both input and output tokens, enforcing limits across minute, daily, weekly, or monthly intervals. When a limit is reached, additional requests are rejected until the time window refreshes.

Token limits are defined as the number of tokens for the following timeframes: minute, day, week, month.

##### Example

In this example, we define the `user` role with daily token usage limits for the `chat-gpt-35-turbo` model .

```json
"roles": {
    "user": {
        "limits": {
            "chat-gpt-35-turbo": {
                "day": "10000000"
            }
        }
    }
}
```

#### Cost Limit

Cost-based rate limiting addresses financial governance by setting **monetary** consumption limits across all models available to a specific role. Unlike token limits, which vary in financial impact depending on the model used, cost limits directly control actual spending. Both cost and rate limits operate in parallel, with requests needing to satisfy all applicable limits. When rejected, users receive notifications explaining which specific constraint was triggered.

Cost limits are defined in USD for the following timeframes: minute, day, week, month.

##### Example

In this example, we define the `operator` role with daily cost limits for all models and token usage daily limit for the `chat-gpt-35-turbo` model .

```json
"roles": {
    "user": {
        "limits": {
            "chat-gpt-35-turbo": {
                "day": "10000000",
            }
        },
        "costLimit": {
            "day": 100.00,
        },
    }
}
```

#### Sharing Limits

In DIAL, you can share your private resources with other users or applications. A shared resource becomes available for a recipient(s) in DIAL Chat, DIAL Marketplace and via API. Refer to [Sharing](/docs/platform/7.collaboration-intro.md#sharing) to learn more.

You can configure sharing limits for roles to restrict the maximum number of users who can accept an invitation link for a resource (APPLICATION or FILE) being shared. 

* `invitation_ttl`: TTL of the invitation link. Default: 72 (hrs)
* `max_accepted_users`: The maximum number of users who can accept an invitation link for a resource being shared. The limit is applied to the shared resource. Default: 10 for APPLICATION and UNLIMITED for other resource types.

##### Example

```json
"roles": {
    "user": { // the name of the role
        "share": {
            "APPLICATION": {
                "invitation_ttl": "24",
                "max_accepted_users": "10"
                },
            "FILE": {
                "invitation_ttl": "24",
                "max_accepted_users": "10"
                }
            }
        }
    }
```


