"use strict";(self.webpackChunkdial=self.webpackChunkdial||[]).push([[931],{12659:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>c});var s=i(85893),t=i(11151);const o={},l="How to Set Keycloak as Identity Provider",r={id:"tutorials/devops/auth-and-access-control/configure-idps/keycloak",title:"keycloak",description:"Table of Contents",source:"@site/docs/tutorials/2.devops/2.auth-and-access-control/3.configure-idps/keycloak.md",sourceDirName:"tutorials/2.devops/2.auth-and-access-control/3.configure-idps",slug:"/tutorials/devops/auth-and-access-control/configure-idps/keycloak",permalink:"/tutorials/devops/auth-and-access-control/configure-idps/keycloak",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"CustomSideBar",previous:{title:"google",permalink:"/tutorials/devops/auth-and-access-control/configure-idps/google"},next:{title:"okta",permalink:"/tutorials/devops/auth-and-access-control/configure-idps/okta"}},a={},c=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"Introduction",id:"introduction",level:2},{value:"Configuration Guidelines",id:"configuration-guidelines",level:2},{value:"Configure Keycloak",id:"configure-keycloak",level:3},{value:"Configuration in Keycloak Admin Console",id:"configuration-in-keycloak-admin-console",level:4},{value:"Configuration in Keycloak Config CLI",id:"configuration-in-keycloak-config-cli",level:4},{value:"Configure AI DIAL",id:"configure-ai-dial",level:3},{value:"AI DIAL Chat Settings",id:"ai-dial-chat-settings",level:4},{value:"AI DIAL Core Settings",id:"ai-dial-core-settings",level:4},{value:"Assignment of Roles",id:"assignment-of-roles",level:4}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"how-to-set-keycloak-as-identity-provider",children:"How to Set Keycloak as Identity Provider"}),"\n",(0,s.jsxs)("div",{class:"docusaurus-ignore",children:[(0,s.jsx)(n.h2,{id:"table-of-contents",children:"Table of Contents"}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#introduction",children:"Introduction"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"#configuration-guidelines",children:"Configuration Guidelines"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"#configure-keycloak",children:"Configure Keycloak"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#configuration-in-keycloak-admin-console",children:"Configuration in Keycloak Admin Console"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#configuration-in-keycloak-config-cli",children:"Configuration in Keycloak Config CLI"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"#configure-ai-dial",children:"Configure AI DIAL"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#ai-dial-chat-settings",children:"AI DIAL Chat Settings"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#ai-dial-core-settings",children:"AI DIAL Core Settings"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#assignment-of-roles",children:"Assignment of Roles"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]})]}),"\n",(0,s.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,s.jsxs)(n.p,{children:["This basic tutorial demonstrates how to create a Realm in ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org",children:"Keycloak"})," and use it as an identity and access management solution for AI DIAL users."]}),"\n",(0,s.jsx)(n.p,{children:"In AI DIAL, you can assign roles to Models and Applications to restrict the number of tokens that can be transmitted in a specific time frame. These roles and their limitations can be created in external systems and then assigned in AI DIAL's configuration."}),"\n",(0,s.jsx)(n.h2,{id:"configuration-guidelines",children:"Configuration Guidelines"}),"\n",(0,s.jsx)(n.h3,{id:"configure-keycloak",children:"Configure Keycloak"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note"}),": Replace ",(0,s.jsx)(n.code,{children:"<chat_url>"})," with the actual address of your AI DIAL Chat application."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"There are two ways to configure Keycloak: via Admin Console or using a CLI tool."}),"\n",(0,s.jsx)(n.h4,{id:"configuration-in-keycloak-admin-console",children:"Configuration in Keycloak Admin Console"}),"\n",(0,s.jsx)(n.p,{children:"Follow these steps to configure Keycloak in Admin Console:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Create Realm"}),": create a new ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/#proc-creating-a-realm_server_administration_guide",children:"Realm"})," in Keycloak. For example, you can name it ",(0,s.jsx)(n.code,{children:"dial"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Create a Client"}),": In ",(0,s.jsx)(n.strong,{children:"Clients"})," ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/#proc-creating-oidc-client_server_administration_guide",children:"Create client"})," with the following settings:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Client type"}),": ",(0,s.jsx)(n.code,{children:"OpenID Connect"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Client ID"}),": e.g., ",(0,s.jsx)(n.code,{children:"ai-dial-chat"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Client authentication"}),": ",(0,s.jsx)(n.code,{children:"On"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Authentication flow"}),": ",(0,s.jsx)(n.code,{children:"Standard flow"}),", ",(0,s.jsx)(n.code,{children:"Direct access grants"})]}),"\n",(0,s.jsxs)(n.li,{children:["Root URL: ",(0,s.jsx)(n.code,{children:"<chat_url>"})]}),"\n",(0,s.jsxs)(n.li,{children:["Valid redirect URIs: ",(0,s.jsx)(n.code,{children:"<chat_url>/*"})]}),"\n",(0,s.jsxs)(n.li,{children:["Home URL: ",(0,s.jsx)(n.code,{children:"<chat_url>"})]}),"\n",(0,s.jsxs)(n.li,{children:["Web origins: ",(0,s.jsx)(n.code,{children:"<chat_url>"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Gather facts"}),": to proceed with DIAL configuration, collect information related to Keycloak:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Keycloak host URL"})," (",(0,s.jsx)(n.code,{children:"<keycloak_host>"}),"), e.g. ",(0,s.jsx)(n.code,{children:"https://keycloak.example.com"})]}),"\n",(0,s.jsxs)(n.li,{children:["In ",(0,s.jsx)(n.strong,{children:"Realm settings/General"}),", save the ",(0,s.jsx)(n.strong,{children:"Realm name"})," (",(0,s.jsx)(n.code,{children:"<keycloak_realm_id>"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["In ",(0,s.jsx)(n.strong,{children:"Realm settings/General"}),", open ",(0,s.jsx)(n.strong,{children:"OpenID Endpoint Configuration"})," and save the ",(0,s.jsx)(n.strong,{children:"jwks_uri"})," (",(0,s.jsx)(n.code,{children:"<keycloak_jwks_uri>"}),") value from JSON response."]}),"\n",(0,s.jsxs)(n.li,{children:["In ",(0,s.jsx)(n.strong,{children:"Clients/Client name/Settings"}),", save the ",(0,s.jsx)(n.strong,{children:"Client ID"})," (",(0,s.jsx)(n.code,{children:"<keycloak_client_id>"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["In ",(0,s.jsx)(n.strong,{children:"Clients/Client name/Credentials"}),", save the ",(0,s.jsx)(n.strong,{children:"Client secret"})," (",(0,s.jsx)(n.code,{children:"<keycloak_client_secret>"}),")."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Create Users"}),": create ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/#proc-creating-user_server_administration_guide",children:"Users"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["(Optional, RBAC) ",(0,s.jsx)(n.strong,{children:"Create and Assign Roles"}),": the best way to sustainably manage user authentication is creating user groups and assigning client roles to that groups:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["In ",(0,s.jsx)(n.strong,{children:"Clients/Client name/Roles"}),", ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/#con-client-roles_server_administration_guide",children:"Create roles"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["In ",(0,s.jsx)(n.strong,{children:"Groups"}),", ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/#proc-managing-groups_server_administration_guide",children:"Create groups"}),". Add users in ",(0,s.jsx)(n.strong,{children:"Members"})," tab, client roles in ",(0,s.jsx)(n.strong,{children:"Role Mappings"})," tab."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"configuration-in-keycloak-config-cli",children:"Configuration in Keycloak Config CLI"}),"\n",(0,s.jsxs)(n.p,{children:["For setting up Keycloak, which is included in the AI DIAL Helm chart, you can use ",(0,s.jsx)(n.a,{href:"https://github.com/bitnami/containers/tree/main/bitnami/keycloak-config-cli#configuration",children:"Keycloak Config CLI"}),". We suggest using the following configuration, which can be passed to ",(0,s.jsx)(n.code,{children:'keycloak.keycloakConfigCli.configuration."realm\\.yaml"'})," in the DIAL ",(0,s.jsx)(n.a,{href:"https://github.com/epam/ai-dial-helm/blob/56b41d6f3c2148b42bdd12c1dcecc9711e23fd6d/charts/dial/values.yaml#L29",children:"Helm chart"}),"."]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note"}),": Replace ",(0,s.jsx)(n.code,{children:"<chat_url>"}),", ",(0,s.jsx)(n.code,{children:"<keycloak_client_secret>"})," with real values before applying this configuration."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'realm: "dial"\ndisplayName: "dial"\nenabled: true\naccessTokenLifespan: 86400\nssoSessionIdleTimeout: 86400\nssoSessionMaxLifespan: 86400\nroles:\n  client:\n    dial-chat:\n      - name: admin\n        description: "AI DIAL chat admin role"\n        composite: false\n        clientRole: true\ngroups:\n  - name: DIAL\n    subGroups:\n      - name: "admin"\n        clientRoles:\n          dial-chat: ["admin"]\nclientScopes:\n  - name: dial\n    description: "dial scope"\n    protocol: openid-connect\n    attributes:\n      include.in.token.scope: "true"\n      display.on.consent.screen: "true"\n      consent.screen.text: ""\n    protocolMappers:\n      - name: "Audience for DIAL"\n        protocol: openid-connect\n        protocolMapper: oidc-audience-mapper\n        consentRequired: false\n        config:\n          included.client.audience: dial-chat\n          id.token.claim: false\n          access.token.claim: true\nclients:\n  - clientId: dial-chat\n    name: dial-chat\n    description: AI DIAL chat client\n    rootUrl: https://<chat_url>\n    adminUrl: https://<chat_url>\n    baseUrl: https://<chat_url>\n    surrogateAuthRequired: false\n    enabled: true\n    clientAuthenticatorType: client-secret\n    secret: <keycloak_client_secret>\n    redirectUris:\n      - https://<chat_url>/*\n    webOrigins:\n      - https://<chat_url>\n    notBefore: 0\n    bearerOnly: false\n    consentRequired: false\n    standardFlowEnabled: true\n    implicitFlowEnabled: false\n    directAccessGrantsEnabled: true\n    serviceAccountsEnabled: false\n    publicClient: false\n    frontchannelLogout: true\n    protocol: openid-connect\n    attributes:\n      oidc.ciba.grant.enabled: "false"\n      client.secret.creation.time: "1691398764"\n      backchannel.logout.session.required: "true"\n      display.on.consent.screen: "false"\n      oauth2.device.authorization.grant.enabled: "false"\n      backchannel.logout.revoke.offline.tokens: "false"\n    authenticationFlowBindingOverrides: {}\n    fullScopeAllowed: true\n    nodeReRegistrationTimeout: -1\n    defaultClientScopes:\n      - web-origins\n      - acr\n      - profile\n      - roles\n      - email\n      - dial\n      - basic\n    optionalClientScopes:\n      - address\n      - phone\n      - offline_access\n      - microprofile-jwt\n'})}),"\n",(0,s.jsx)(n.h3,{id:"configure-ai-dial",children:"Configure AI DIAL"}),"\n",(0,s.jsx)(n.p,{children:"By configuring both AI DIAL Chat and AI DIAL Core with the necessary environment variables, you will enable them to work together seamlessly with Identity Provider for authentication and authorization purposes."}),"\n",(0,s.jsx)(n.h4,{id:"ai-dial-chat-settings",children:"AI DIAL Chat Settings"}),"\n",(0,s.jsxs)(n.p,{children:["Add the following environment variables to AI DIAL Chat ",(0,s.jsx)(n.a,{href:"https://github.com/epam/ai-dial-chat/blob/development/apps/chat/README.md#environment-variables",children:"configuration"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'AUTH_KEYCLOAK_HOST: "https://<keycloak_host>/realms/<keycloak_realm_id>"\nAUTH_KEYCLOAK_CLIENT_ID: "<keycloak_client_id>"\nAUTH_KEYCLOAK_SECRET: "<keycloak_client_secret>"\n'})}),"\n",(0,s.jsx)(n.h4,{id:"ai-dial-core-settings",children:"AI DIAL Core Settings"}),"\n",(0,s.jsxs)(n.p,{children:["Add the following parameters to AI DIAL Core ",(0,s.jsxs)(n.a,{href:"https://github.com/epam/ai-dial-core?tab=readme-ov-file#static-settings",children:[(0,s.jsx)(n.strong,{children:"static"})," settings"]}),":"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note"}),": ",(0,s.jsx)(n.code,{children:"<keycloak_host_regex>"})," is ",(0,s.jsx)(n.code,{children:"<keycloak_host>"})," with dots escaped, e.g. ",(0,s.jsx)(n.code,{children:"keycloak\\.example\\.com"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note"}),": generate some random sting for ",(0,s.jsx)(n.code,{children:"loggingSalt"})," parameter, e.g. using ",(0,s.jsx)(n.code,{children:"pwgen -s 32 1"})]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'aidial.identityProviders.keycloak.jwksUrl: "<keycloak_jwks_uri>"\naidial.identityProviders.keycloak.issuerPattern: \'^https:\\/\\/<keycloak_host_regex>.*$\'\naidial.identityProviders.keycloak.loggingKey: "sub"\naidial.identityProviders.keycloak.loggingSalt: "loggingSalt"\naidial.identityProviders.keycloak.rolePath: "resource_access.<keycloak_client_id>.roles"\n'})}),"\n",(0,s.jsx)(n.h4,{id:"assignment-of-roles",children:"Assignment of Roles"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Warning"}),": RBAC-related steps from ",(0,s.jsx)(n.a,{href:"#configure-keycloak",children:"Configure Keycloak"})," must be completed before proceeding with this section."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["To limit access to AI DIAL resources based on Keycloak Groups, configure the AI DIAL Core by adjusting the ",(0,s.jsx)(n.a,{href:"https://github.com/epam/ai-dial-core?tab=readme-ov-file#dynamic-settings",children:"Dynamic settings"}),": set the ",(0,s.jsx)(n.code,{children:"userRoles"})," parameter to align with the desired Keycloak group names."]}),"\n",(0,s.jsxs)(n.p,{children:["In the provided example, users assigned the ",(0,s.jsx)(n.code,{children:"keycloak-group-name"})," group will have access to the ",(0,s.jsx)(n.code,{children:"chat-gpt-35-turbo"})," model."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "models": {\n    "gpt-35-turbo": {\n      "type": "chat",\n      "endpoint": "http://localhost:5000/v1/openai/deployments/gpt-35-turbo/chat/completions",\n      "upstreams": [\n        {\n          "endpoint": "https://[REDACTED].openai.azure.com/openai/deployments/gpt-35-turbo/chat/completions",\n          "key": "[REDACTED]"\n        }\n      ],\n      "userRoles": [\n        "keycloak-client-role-name"\n      ]\n    }\n  }\n}\n'})})]})}function h(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},11151:(e,n,i)=>{i.d(n,{Z:()=>r,a:()=>l});var s=i(67294);const t={},o=s.createContext(t);function l(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);